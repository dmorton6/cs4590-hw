<!-- 
Author: Daniel Morton
-->
<html>
<head>
<title>Daniel Morton - HW 2</title>
</head>
<body>
  <p><b>Source 1 </b>
  <br /> 
  <!-- start/stop for source 1 --> <button onclick="toggleSound(1)">Play/Stop</button> 
  <!-- volume fader for source 1 --> <div> 
  Volume: <input type="text" id="leftVolume" style="border: 0; color: #f6931f; font-weight: bold;" />
  <link rel="stylesheet" href="jquery-ui-1.10.3/themes/base/jquery-ui.css" />
  <script src="jquery-ui-1.10.3/jquery-1.9.1.js"></script>
  <script src="jquery-ui-1.10.3/ui/jquery-ui.js"></script>  
  <script>
    $(function() {
    $( "#fader_source1" ).slider({
      orientation: "horizontal",
      range: "min",
      min: 0,
      max: 100,
      value: 50,
      slide: function( event, ui ) {
        $( "#leftVolume" ).val( ui.value );
      }
    });
    $( "#leftVolume" ).val( $( "#fader_source1" ).slider( "value" ) );
  });
  </script>
  <div id="fader_source1" style="width: 200px;" onmouseup="restartSound(1)"></div>
  <br />
  </div>
  <!-- buttons to set SG mode --> <div> 
  <button onclick="setSGMode(1,'osc')">Oscillator Mode</button><button onclick="setSGMode(1,'file')">File Mode</button>
  <br />Frequency: <input type="text" class="button" id="freq1" value="440">
  <br />
  </div>
  <!-- wave type selection for osc. 1 --> <div>
  Wave type: 
  <button onclick="setOscType(1,'sine')">Sine</button>
  <button onclick="setOscType(1,'square')">Square</button>
  <button onclick="setOscType(1,'sawtooth')">Sawtooth</button>
  <button onclick="setOscType(1,'triangle')">Triangle</button>
  </div>
  <!-- control slider--> <div>
  <br />
  Control for frequency or playback speed.
  <input type="text" id="leftControl" style="border: 0; color: #f6931f; font-weight: bold;" />
  <link rel="stylesheet" href="jquery-ui-1.10.3/themes/base/jquery-ui.css" />
  <script src="jquery-ui-1.10.3/jquery-1.9.1.js"></script>
  <script src="jquery-ui-1.10.3/ui/jquery-ui.js"></script>  
  <script>
  $(function() {
    $( "#control_source1" ).slider({
      orientation: "horizontal",
      range: "min",
      min: 2,
      max: 50,
      value: 10,
      slide: function( event, ui ) {
        $( "#leftControl" ).val( ui.value );
      }
    });
    $( "#leftControl" ).val( $( "#control_source1" ).slider( "value" ) );
  });
  </script>
  <div id="control_source1" style="width: 200px;" onmousedown="mouseOnSlider(1)" onmousemove="mouseMoving(1)" onmouseup="play(1)"></div>
  <font size="2">The above value is irrelephant. The only thing that matters is how fast the slider is moved.</font>
  <br />
  
  
  </div>
  <!-- playback in reverse code would go here -->
  </p>
  <br /><br />
  
  <p><b>Source 2 </b> 
  <br /> 
  <!-- start/stop for source 2 --> <button onclick="toggleSound(2)">Play/Stop</button>
  <!-- volume fader for source 2 --> <div> 
  Volume: <input type="text" id="rightVolume" style="border: 0; color: #f6931f; font-weight: bold;" />
  <link rel="stylesheet" href="jquery-ui-1.10.3/themes/base/jquery-ui.css" />
  <script src="jquery-ui-1.10.3/jquery-1.9.1.js"></script>
  <script src="jquery-ui-1.10.3/ui/jquery-ui.js"></script>  
  <script>
    $(function() {
    $( "#fader_source2" ).slider({
      orientation: "horizontal",
      range: "min",
      min: 0,
      max: 100,
      value: 50,
      slide: function( event, ui ) {
        $( "#rightVolume" ).val( ui.value );
      }
    });
    $( "#rightVolume" ).val( $( "#fader_source2" ).slider( "value" ) );
  });
  </script>
  <div id="fader_source2" style="width: 200px;" onmouseup="restartSound(2)"></div>
  <br />
  </div>
  <!-- buttons to set SG mode --> <div> 
  <button onclick="setSGMode(2,'osc')">Oscillator Mode</button> <button onclick="setSGMode(2,'file')">File Mode</button>
  <br />Frequency: <input type="text" class="button" id="freq2" value="659">
  <br />
  </div>
  <!-- wave type selection for osc. 2 --> <div>
  Wave type: 
  <button onclick="setOscType(2,'sine')">Sine</button>
  <button onclick="setOscType(2,'square')">Square</button>
  <button onclick="setOscType(2,'sawtooth')">Sawtooth</button>
  <button onclick="setOscType(2,'triangle')">Triangle</button>
  </div>
  <!-- control slider--> <div>
  Control for frequency or playback speed.
  <input type="text" id="rightControl" style="border: 0; color: #f6931f; font-weight: bold;" />
  <link rel="stylesheet" href="jquery-ui-1.10.3/themes/base/jquery-ui.css" />
  <script src="jquery-ui-1.10.3/jquery-1.9.1.js"></script>
  <script src="jquery-ui-1.10.3/ui/jquery-ui.js"></script>  
  <script>
  $(function() {
    $( "#control_source2" ).slider({
      orientation: "horizontal",
      range: "min",
      min: 2,
      max: 50,
      value: 10,
      slide: function( event, ui ) {
        $( "#rightControl" ).val( ui.value );
      }
    });
    $( "#rightControl" ).val( $( "#control_source2" ).slider( "value" ) );
  });
  </script>
  <div id="control_source2" style="width: 200px;" onmousedown="mouseOnSlider(2)" onmousemove="mouseMoving(2)" onmouseup="play(2)"></div>
  <font size="2">The above value is irrelephant. The only thing that matters is how fast the slider is moved.</font>
  <br />
  </div>
  <!-- playback in reverse code would go here -->
  </p>
  <br /><br />
  
  <!-- Mixer --> <div>
  <b>Mixer</b>
  <br />LPF frequency: <input type="text" class="button" id="freqLPF" value="300"> <!-- LPF frequency input -->
  <button onclick="setLPF(true)">LPF on</button> <button onclick="setLPF(false)">LPF off</button> <!--LPF on/off buttons -->
  <br />HPF frequency: <input type="text" class="button" id="freqHPF" value="2000"> <!-- HPF frequency input --> 
  <button onclick="setHPF(true)">HPF on</button> <button onclick="setHPF(false)">HPF off</button> <!--HPF on/off buttons -->
  <br /><br />
  </div>
  <!-- cross-fader --> <div>
  Cross-fader: <input type="text" id="fadeVal" style="border: 0; color: #f6931f; font-weight: bold;" />
  <link rel="stylesheet" href="jquery-ui-1.10.3/themes/base/jquery-ui.css" />
  <script src="jquery-ui-1.10.3/jquery-1.9.1.js"></script>
  <script src="jquery-ui-1.10.3/ui/jquery-ui.js"></script>  
  <script>
  $(function() {
    $( "#crossfader" ).slider({
      orientation: "horizontal",
      range: "min",
      min: 0,
      max: 100,
      value: 50,
      slide: function( event, ui ) {
        $( "#fadeVal" ).val( ui.value );
      }
    });
    $( "#fadeVal" ).val( $( "#crossfader" ).slider( "value" ) );
  });
  </script> 
  <div id="crossfader" style="width: 200px;" onmouseup="restartSound(3)"></div>
  <font size="2">0 represents a complete source 1 fade. 100 represents a complete source 2 fade.</font>
  </div> 
  <br /
  
  

<!-- JavaScript code -->  
<script>

if (!window.webkitAudioContext) {
  alert('The Web Audio API is not supported in this browser!');
}

/* variables */ {
var context = new window.webkitAudioContext();
var source1 = context.createOscillator();
var source2 = context.createOscillator();
var soundPlaying1 = false;
var soundPlaying2 = false;
var sgmode1 = "osc"; // Sound Generator mode - in Oscillator Mode by default
var sgmode2 = "osc"; 
var osc1_type = "sine"; // Oscillator mode - sine wave by default
var osc2_type = "sine";
var LPFon = false; // filter values originally set to "off"
var HPFon = false;  
var LPF = null;
var HPF = null;
var mouseOnSlider1 = false; // variables for whether the mouse is on the control slider
var mouseOnSlider2 = false; 
var timeLastReleased1 = context.currentTime; // variables for the moment when the control slider (for each source) was last released
var timeLastReleased2 = context.currentTime;
var valueAtLastReleased1 = 10; // variable for the value of the control slider when it was last released
var valueAtLastReleased2 = 10; 
var sourceMultiplier1 = 1; // variables for the source multiplier based on slider movement speed
var sourceMultiplier2 = 1;
var playbackBuffer1 = null; // variables for file playback
var playbackBuffer2 = null; 
var audioSource1 = null;
var audioSource2 = null;
var playbackPosition = 0;
var playbackStart = 0;
var playbackPause = 0;
var playbackSpeed1 = 1; // playback rate for each source
var playbackSpeed2 = 1;
}


// This function toggles between stopping and starting a sound
function toggleSound(sourceNum) {
  if (sourceNum == 1) {
    if (soundPlaying1) stopSound(1); 
	else play(1); 
  }
  else {
    if (soundPlaying2) stopSound(2); 
	else play(2); 
  }
  //alert("source 1 is " + soundPlaying1 + " and source 2 is " + soundPlaying2); // for testing purposes
}

// This function resets the sound if anything is playing, then begins playback
function restartSound(sourceNum) {
  if (sourceNum == 1) {
    if (!soundPlaying1) return; // Don't want to put sound on if it's not on already
	if (soundPlaying2) {
	  stopSound(2); // Refresh sound 2
	  play(2); 	
	}
	stopSound(1); // Refresh sound 1
	play(1);
	return;
  }
  else if (sourceNum == 2) {
    if (!soundPlaying2) return;
	if (soundPlaying1) {
	  stopSound(1); // Refresh sound 1
	  play(1);
	}
	stopSound(2); // Refresh sound 2
	play(2);
	return;
  }
  else if (sourceNum == 3) {
    // for both sources
	if (!soundPlaying1) {
	  if (!soundPlaying2) return; // if no sound is currently playing
	  // else, only sound 2 is playing
	  stopSound(2);
	  play(2);
	  return;
	}
	if (!soundPlaying2) {
	 // only sound 1 is playing
	 stopSound(1);
	 play(1);
	 return;
	}
	// else, both sounds are playing
	stopSound(3); 
	play(3); 
  }
}
 
// This function stops all sound and does not restart
function stopSound(sourceNum) {
  //alert("stopping " + sourceNum);
  if (sourceNum == 1) {
    source1.noteOff(0);
	soundPlaying1 = false;
  }
  else if (sourceNum == 2) {
	source2.noteOff(0);
	soundPlaying2 = false;
  }
  else if (sourceNum == 3) {
	source1.noteOff(0);
	source2.noteOff(0);
	soundPlaying1 = false;
	soundPlaying2 = false;
  }
}

// This function plays sound for a specific source
function play(sourceNum) {  
  if (sourceNum == 1 || sourceNum == 3) {
    if (sgmode1 == "osc") {
      source1 = context.createOscillator();
      source1.frequency.value = document.getElementById("freq1").value - "0"; // frequency for oscillator 1
  	  source1.frequency.value *= sourceMultiplier1;
      source1.type = osc1_type;
	  source1.loop = false;
    }
  
  /* Note: was unable to figure out how to implement this before midnight */
    if (sgmode1 == "file") {
	  source1.loop = true;
	}
  }

  if (sourceNum == 2 || sourceNum == 3) {
    if (sgmode2 == "osc") {
      source2 = context.createOscillator();
      source2.frequency.value = document.getElementById("freq2").value - "0"; // frequency for oscillator 2
	  source2.frequency.value *= sourceMultiplier2;
	  source2.type = osc2_type;
	  source2.loop = false;
    }
  
    /* Note: was unable to figure out how to implement this before midnight */
    if (sgmode2 == "file") {
	  source2.loop = true;
	}
	// Set the playback rate for source 2
	// This will be set for the audio buffer
	//buffer.playbackRate.value = playbackSpeed2;
    source2.loop = true;
  }

  
  /* Gain nodes */ {
  //Create "Source" gain nodes and "Crossfader" gain nodes
  gain_source1 = context.createGainNode();
  gain_source2 = context.createGainNode();
  crossfade_source1 = context.createGainNode();
  crossfade_source2 = context.createGainNode();
 
  // Get gain values for sources 1 and 2  
  gain_source1.gain.value = (document.getElementById("leftVolume").value - "0")/200;
  gain_source2.gain.value = (document.getElementById("rightVolume").value - "0")/200;
  
  // Get gain values for crossfader
  leftCFGain = 1/2 - (document.getElementById("fadeVal").value - "0")/200;
  rightCFGain = (document.getElementById("fadeVal").value - "0")/200;
  crossfade_source1.gain.value = leftCFGain;
  crossfade_source2.gain.value = rightCFGain;	
 
  // Connect sources to source gain nodes
  if (sourceNum == 1 || sourceNum == 3) source1.connect(gain_source1); // only reconnect if this is the node we want to reconnect
  if (sourceNum == 2 || sourceNum == 3) source2.connect(gain_source2);
  gain_source1.connect(crossfade_source1);
  gain_source2.connect(crossfade_source2);
  }
  
  // Connect crossfaded sounds to filters, based on whether filters are needed  
  if (!LPFon && !HPFon) {
   // no LPF, no HPF - connect straight to destination
	crossfade_source1.connect(context.destination);
	crossfade_source2.connect(context.destination);
  }
  else if (!LPFon && HPFon) {
	// HPF, no LPF - connect to HPF then destination
	HPF = context.createBiquadFilter();
	HPF.type = 1; // for HPF
	HPF.frequency.value = document.getElementById("freqHPF").value - "0";
	crossfade_source1.connect(HPF);
    crossfade_source2.connect(HPF); 
	HPF.connect(context.destination);
  }
  else if (LPFon && !HPFon) {
    // LPF, no HPF - connect to LPF then destination
    LPF = context.createBiquadFilter();
	LPF.type = 0; // for LPF
	LPF.frequency.value = document.getElementById("freqLPF").value - "0";
	crossfade_source1.connect(LPF); 
	crossfade_source2.connect(LPF); 
	LPF.connect(context.destination); 
  }
  else {
    // LPF and HPF - connect to both then destination
	LPF = context.createBiquadFilter();
	HPF = context.createBiquadFilter();
	LPF.type = 0; // for LPF
	HPF.type = 1; // for HPF
	LPF.frequency.value = document.getElementById("freqLPF").value - "0";
	HPF.frequency.value = document.getElementById("freqHPF").value - "0";
	
	crossfade_source1.connect(LPF);
	crossfade_source2.connect(LPF);
	LPF.connect(HPF);
	HPF.connect(context.destination);
  }
  
  
  if (sourceNum == 1) {
	source1.noteOn(0);
    soundPlaying1 = true;
	return;
  }
  else if (sourceNum == 2){
    source2.noteOn(0);
	soundPlaying2 = true;
	return;
  }
  else if (sourceNum == 3) {
    // both sounds
    source1.noteOn(0);
	source2.noteOn(0);
	soundPlaying1 = true;
	soundPlaying2 = true;
	alert("source 1 is " + soundPlaying1 + " and source 2 is " + soundPlaying2);
	return;
  }
}

function setOscType(osc, type) {
   
  // Set to the appropriate oscillator
  if (osc == 1) {
    if (osc1_type == type) return;
    osc1_type = type;
	if (soundPlaying1) restartSound(1);
  }
  else {
    if (osc2_type == type) return;
    osc2_type = type;
	if (soundPlaying2) restartSound(2);
  }
}

// Functions to turn filters on/off
function setLPF(isOn) {
  // Input of 0 sets LPF to off; input of 1 sets LPF on
  LPFon = isOn;
  restartSound(3);
}

function setHPF(isOn) {
  // Input of 0 sets LPF to off; input of 1 sets LPF on
  HPFon = isOn;
  restartSound(3);
}

// Function to set the sound generator values
function setSGMode(sg, mode) {
  //alert("mode is " + mode + " and sgmode1 is " + sgmode1);
  if (sg == 1) {
    // source 1
    sgmode1 = mode;
	restartSound(1);
  }
  else {
    // source 2
    sgmode2 = mode;
	restartSound(2);
  }
  
}


// Function to stop source sound if the mouse is on that source's slider
function mouseOnSlider(sliderNum) {
  if (sliderNum == 1) {
    if (soundPlaying1) stopSound(1);
    mouseOnSlider1 = true;
  }
  else if (sliderNum == 2) {
    if (soundPlaying2) stopSound(2); 
    mouseOnSlider2 = true;
  }
}

// Function to change the playback speed or frequency based on mouse movement
function mouseMoving(sourceNum) {
  var newValue;
  var newTime;
  
  if (mouseOnSlider1 && sourceNum == 1) {
    newValue = document.getElementById("leftControl").value;
    newTime = context.currentTime;
	speed = (newValue - valueAtLastReleased1) / (newTime - timeLastReleased1);
    if (sgmode1 == "file") { // adjust the audio file playback speed	
      playbackBuffer1 = context.createBufferSource();
      playbackBuffer1.playbackRate.value = speed;
	}
	else { // adjust the oscillator frequency value based on an arbitrary formula
	  if (speed > 0) sourceMultiplier1 = Math.log(speed)/2;
	  if (speed < 0) sourceMultiplier1 = 2/Math.log(-speed);
	}
	// set the old values equal to the new values
	valueAtLastReleased1 = newValue;
	timeLastReleased1 = newTime;
  }
  else if (mouseOnSlider2 && sourceNum == 2) {
    newValue = document.getElementById("rightControl").value;
    newTime = context.currentTime;
	speed = (newValue - valueAtLastReleased2) / (newTime - timeLastReleased2);
    if (sgmode2 == "file") { // adjust the audio file playback speed	
      playbackBuffer2 = context.createBufferSource();
      playbackBuffer2.playbackRate.value = speed;
	}
	else { // adjust the oscillator frequency value based on an arbitrary formula
	  if (speed > 0) sourceMultiplier2 = Math.log(speed)/2;
	  if (speed < 0) sourceMultiplier2 = 2/Math.log(-speed);
	}
	// set the old values equal to the new values
	valueAtLastReleased2 = newValue;
	timeLastReleased2 = newTime;
  }	
}



</script>
</body>
</html>
